<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding ZCL clusters to application &mdash; nRF Connect SDK 2.3.99 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/nordic.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/nrf.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" /> 
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=G-ZPVZRKFQJR"></script>
        <script src="../../_static/js/ga-tracker.js"></script>
        <script data-culture="EN" id="CookieConsent" type="text/javascript" src="https://policy.app.cookieinformation.com/uc.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
<script
  type="text/javascript"
  src="../../_static/js/ncs.js"
></script>
<script src="../../_static/js/bootstrap.bundle.min.js"></script>

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Configuring Zigbee samples for other ecosystems" href="other_ecosystems.html" />
    <link rel="prev" title="Configuring ZBOSS traces in nRF Connect SDK" href="configuring_zboss_traces.html" />
<link
  href="../../_static/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link
  rel="shortcut icon"
  href="../../_static/images/favicon.ico"
/>

</head>

<body class="wy-body-for-nav">
<div class="announcement"></div>
<div class="d-print-none ncs-header">
  <div class="container-xl ncs-header-top">
    <div class="row h-100">
      <div class="d-none d-md-block col-2">
        <div class="bg-white py-4 px-3 ml-2 ncs-header-logo">
          <img
            class="ncs-header-logo"
            src="../../_static/images/nordic-logo.png"
            alt=""
          />
        </div>
      </div>
      <div
        class="col-8 col-md-7 pl-md-4 d-flex align-self-center justify-content-center"
      >
        <form class="w-75" action="../../search.html" method="get">
          <div class="form-group">
            <input
              type="text"
              name="q"
              class="ncs-search-input form-control"
              placeholder="Search all docs..."
            />
          </div>
        </form>
      </div>
      <div class="col-4 col-md-3 d-md-block p-3 text-end">
        <div class="dropdown">
          <button
            class="btn dropdown-toggle ncs-btn-versions"
            type="button"
            id="dropdownMenuButton1"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <span class="d-none d-md-inline">nRF Connect SDK</span>
            <span id="ncsversion" class="d-inline"></span>
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="ncs-header-nav">
    <div class="container-xl">
      <div class="row">
        <div class="col col-12 d-flex justify-content-center">
          <nav class="navbar navbar-dark navbar-expand-lg p-0">
            <span class="navbar-brand d-block d-lg-none py-2 pl-1"
              >Documentation sets</span
            >
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarNavAltMarkup"
              aria-controls="navbarNavAltMarkup"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <ul class="navbar-nav">
                <li class="nav-item active py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../nrf/index.html"
                    >nRF Connect SDK</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../nrfx/index.html"
                    >nrfx</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../nrfxlib/README.html"
                    >nrfxlib</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../zephyr/index.html"
                    >Zephyr Project</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../mcuboot/wrapper.html"
                    >MCUboot</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../tfm/index.html"
                    >Trusted Firmware-M</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../matter/index.html"
                    >Matter</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../kconfig/index.html"
                    >Kconfig Reference</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
              </ul>
            </div>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> nRF Connect SDK
          </a>
              <div class="version">
                2.3.99
              </div>
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_model.html">Development model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../app_dev.html">Application development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecosystem_integration.html">Ecosystems integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf91.html">Working with nRF91 Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf70.html">Working with nRF70 Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf53.html">Working with nRF53 Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf52.html">Working with nRF52 Series</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../protocols.html">Protocols</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../ble/index.html">Bluetooth LE Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bt_mesh/index.html">Bluetooth mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../esb/index.html">Enhanced ShockBurst (ESB)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gazell/index.html">Gazell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../matter/index.html">Matter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multiprotocol/index.html">Multiprotocol support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfc/index.html">Near Field Communication (NFC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thread/index.html">Thread</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wifi/index.html">Wi-Fi</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Zigbee</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="qsg.html">Zigbee quick start guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported_features.html">Supported Zigbee features</a></li>
<li class="toctree-l3"><a class="reference internal" href="architectures.html">Zigbee architectures</a></li>
<li class="toctree-l3"><a class="reference internal" href="commissioning.html">Zigbee commissioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="memory.html">Zigbee memory requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuring.html">Configuring Zigbee in nRF Connect SDK</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuring_libraries.html">Configuring Zigbee libraries in nRF Connect SDK</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuring_zboss_traces.html">Configuring ZBOSS traces in nRF Connect SDK</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Adding ZCL clusters to application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#copy-zigbee-template-sample">Copy Zigbee template sample</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-on-off-switch-and-temperature-sensor-functionalities">Add On/Off Switch and Temperature Sensor functionalities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verify-cluster-changes">Verify cluster changes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#further-expanding-the-custom-application">Further expanding the custom application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="other_ecosystems.html">Configuring Zigbee samples for other ecosystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="tools.html">Zigbee tools</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples.html">Samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drivers.html">Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/index.html">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../known_issues.html">Known issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software_maturity.html">Software maturity levels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation.html">About this documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">nRF Connect SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../protocols.html">Protocols</a></li>
          <li class="breadcrumb-item"><a href="index.html">Zigbee</a></li>
      <li class="breadcrumb-item active">Adding ZCL clusters to application</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/protocols/zigbee/adding_clusters.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-zcl-clusters-to-application">
<span id="ug-zigee-adding-clusters"></span><h1>Adding ZCL clusters to application<a class="headerlink" href="#adding-zcl-clusters-to-application" title="Permalink to this heading"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#requirements" id="id6">Requirements</a></p></li>
<li><p><a class="reference internal" href="#copy-zigbee-template-sample" id="id7">Copy Zigbee template sample</a></p></li>
<li><p><a class="reference internal" href="#add-on-off-switch-and-temperature-sensor-functionalities" id="id8">Add On/Off Switch and Temperature Sensor functionalities</a></p>
<ul>
<li><p><a class="reference internal" href="#add-on-off-switch-device" id="id9">Add On/Off Switch device</a></p></li>
<li><p><a class="reference internal" href="#add-temperature-sensor-device" id="id10">Add Temperature Sensor device</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#verify-cluster-changes" id="id11">Verify cluster changes</a></p>
<ul>
<li><p><a class="reference internal" href="#prepare-network-coordinator-for-testing" id="id12">Prepare network coordinator for testing</a></p></li>
<li><p><a class="reference internal" href="#run-the-extended-application" id="id13">Run the extended application</a></p></li>
<li><p><a class="reference internal" href="#verify-cluster-operation" id="id14">Verify cluster operation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#further-expanding-the-custom-application" id="id15">Further expanding the custom application</a></p>
<ul>
<li><p><a class="reference internal" href="#adding-ota" id="id16">Adding OTA</a></p></li>
<li><p><a class="reference internal" href="#passing-zcl-events-to-the-application" id="id17">Passing ZCL events to the application</a></p></li>
</ul>
</li>
</ul>
</div>
<p>Once you are familiar with Zigbee in the nRF Connect SDK and you have tested some of the available <a class="reference internal" href="../../samples/zigbee.html#zigbee-samples"><span class="std std-ref">Zigbee samples</span></a>, you can use the <a class="reference internal" href="../../samples/zigbee/template/README.html#zigbee-template-sample"><span class="std std-ref">Zigbee template</span></a> sample to create your own application with a custom set of ZCL clusters.
For example, you can create a sensor application that uses a temperature sensor with an on/off switch, with the sensor periodically updating its measured value when it is active.</p>
<p>Adding ZCL clusters to an application consists of expanding the Zigbee template sample with new application clusters.
By default, the template sample includes only mandatory Zigbee clusters, which is the Basic and Identify clusters, required to identify a device within a Zigbee network.</p>
<p>Cluster is a representation of a single functionality within a Zigbee node.
Each cluster contains attributes that are stored in the device’s memory and commands that can be used to modify or read the state of the device, including the cluster attributes.
Clusters appropriate for a single device type such as a sensor or a light bulb are organized into an addressable container that is called an endpoint.
For more information about the ZCL terminology, see <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/using_zigbee__z_c_l.html#ZCL_definitions">Common ZCL terms and definitions</a> in the ZBOSS stack user guide.</p>
<p>An application can implement appropriate callback functions to be informed about specific cluster state changes.
These functions can be used to alter the device’s behavior when the state of a cluster is changing as a result of some external event.</p>
<p>Read the following sections for detailed steps about how to expand the Zigbee template sample.</p>
<section id="requirements">
<span id="ug-zigee-adding-clusters-requirements"></span><h2><a class="toc-backref" href="#id6">Requirements</a><a class="headerlink" href="#requirements" title="Permalink to this heading"></a></h2>
<p>To take advantage of this guide, you need to be familiar with <a class="reference internal" href="architectures.html#ug-zigbee-architectures"><span class="std std-ref">Zigbee architectures</span></a> and <a class="reference internal" href="configuring.html#ug-zigbee-configuring"><span class="std std-ref">Configuring Zigbee in nRF Connect SDK</span></a>, and have built and tested at least one of the available <a class="reference internal" href="../../samples/zigbee.html#zigbee-samples"><span class="std std-ref">Zigbee samples</span></a>.</p>
<p>To test the functionalities implemented in this user guide, you need the following hardware and software:</p>
<ul class="simple">
<li><p>One compatible development kit for programming the <a class="reference internal" href="../../samples/zigbee/template/README.html#zigbee-template-sample"><span class="std std-ref">Zigbee template</span></a> sample</p></li>
<li><p>One compatible development kit for programming the <a class="reference internal" href="../../samples/zigbee/network_coordinator/README.html#zigbee-network-coordinator-sample"><span class="std std-ref">Zigbee network coordinator</span></a> sample</p></li>
</ul>
<p>You can also optionally use <a class="reference external" href="https://infocenter.nordicsemi.com/topic/ug_sniffer_802154/UG/sniffer_802154/intro_802154.html">nRF Sniffer for 802.15.4</a> configured for capturing Zigbee packets with Wireshark (see <a class="reference external" href="https://infocenter.nordicsemi.com/topic/ug_sniffer_802154/UG/sniffer_802154/configuring_sniffer_802154_zigbee.html">Configuring Wireshark for Zigbee</a>) to gather some of the required information, such as the short address of a Zigbee node.
However, this guide does not describe Wireshark usage.</p>
</section>
<section class="numbered-step" id="copy-zigbee-template-sample">
<span id="ug-zigee-adding-clusters-copying-template"></span><h2><a class="toc-backref" href="#id7">Copy Zigbee template sample</a><a class="headerlink" href="#copy-zigbee-template-sample" title="Permalink to this heading"></a></h2>
<p>Use the <a class="reference internal" href="../../samples/zigbee/template/README.html#zigbee-template-sample"><span class="std std-ref">Zigbee template</span></a> sample as the base for adding new ZCL clusters:</p>
<ol class="arabic simple">
<li><p>Make sure that you meet the requirements for building the sample.</p></li>
<li><p>Build and test the sample as described on its documentation page.</p></li>
<li><p>Copy the contents of the <code class="file docutils literal notranslate"><span class="pre">samples/zigbee/template</span></code> directory to a new directory meant for your custom application.
For example, <code class="file docutils literal notranslate"><span class="pre">samples/zigbee/sensor</span></code>.</p></li>
</ol>
</section>
<section class="numbered-step" id="add-on-off-switch-and-temperature-sensor-functionalities">
<span id="ug-zigee-adding-clusters-adding-clusters"></span><h2><a class="toc-backref" href="#id8">Add On/Off Switch and Temperature Sensor functionalities</a><a class="headerlink" href="#add-on-off-switch-and-temperature-sensor-functionalities" title="Permalink to this heading"></a></h2>
<p>As mentioned in the introduction, each functionality of a Zigbee node is defined as a cluster, with its unique group of attributes, commands, or functions.
Clusters can be grouped into devices with unique device identifiers.
Moreover, clusters can have either server or client role, which defines the way they are used.</p>
<p>To learn more about the ZCL clusters and their terminology, see the following documentation available to the <a class="reference external" href="https://csa-iot.org">Connectivity Standards Alliance</a> members:</p>
<ul class="simple">
<li><p>Home Automation Profile specification</p></li>
<li><p>ZCL library specification, Client/Server Model section</p></li>
</ul>
<p>Extending the Zigbee node’s functionalities with an On/Off Switch and a Temperature Sensor requires adding On/Off Switch and Temperature Sensor logical devices defined in the Home Automation Profile specification.</p>
<section id="add-on-off-switch-device">
<span id="ug-zigee-adding-clusters-add-switch"></span><h3><a class="toc-backref" href="#id9">Add On/Off Switch device</a><a class="headerlink" href="#add-on-off-switch-device" title="Permalink to this heading"></a></h3>
<p>To create an On/Off Switch device, we are going to declare the following clusters:</p>
<ul class="simple">
<li><p>Identify</p></li>
<li><p>Basic</p></li>
<li><p>On/Off Switch Configuration</p></li>
<li><p>On/Off</p></li>
<li><p>Scenes</p></li>
<li><p>Groups</p></li>
</ul>
<p>We are going to create a cluster list that specifies an On/Off Switch device using the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group__ha__on__off__switch.html#ga566dbde2d408c46c488460219edf6002">ZB_HA_DECLARE_ON_OFF_SWITCH_CLUSTER_LIST</a> macro, which declares a static array of clusters.
Before we declare the cluster list, we are going to create clusters with attributes that can be manipulated, while the macro is going to seamlessly declare clusters that lacks attributes:</p>
<ul class="simple">
<li><p>Identify and Basic - These clusters are already declared in the Zigbee template sample.</p></li>
<li><p>On/Off Switch Configuration - This cluster we are going to create manually.</p></li>
<li><p>On/Off, Scenes, and Groups - These clusters are going to be declared by the macro.</p></li>
</ul>
<p>Complete the following steps:</p>
<ol class="arabic">
<li><p>Open the <code class="file docutils literal notranslate"><span class="pre">main.c</span></code> file of the copied template sample.
You can find this file in the directory to which you <a class="reference internal" href="#ug-zigee-adding-clusters-copying-template"><span class="std std-ref">copied the sample</span></a>.</p></li>
<li><p>Define variables for the On/Off Switch Configuration cluster’s attributes and declare attribute list for them by embedding these attributes into the <code class="docutils literal notranslate"><span class="pre">zb_device_ctx</span></code> structure:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">zb_device_ctx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zb_zcl_basic_attrs_t</span><span class="w">     </span><span class="n">basic_attr</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_zcl_identify_attrs_t</span><span class="w">  </span><span class="n">identify_attr</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_uint8_t</span><span class="w">               </span><span class="n">on_off_switch_type_attr</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_uint8_t</span><span class="w">               </span><span class="n">on_off_switch_actions_attr</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">ZB_ZCL_DECLARE_ON_OFF_SWITCH_CONFIGURATION_ATTRIB_LIST</span><span class="p">(</span>
<span class="w">        </span><span class="n">on_off_switch_attr_list</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">on_off_switch_type_attr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">on_off_switch_actions_attr</span><span class="p">);</span>
</pre></div>
</div>
<p>At this point, you have all the clusters required to declare the On/Off Switch cluster list.</p>
</li>
<li><p>Create the On/Off Switch cluster list using the Basic and Identify clusters from the Zigbee template sample and the On/Off Switch Configuration cluster you’ve just created, as shown in the following snippet:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ZB_HA_DECLARE_ON_OFF_SWITCH_CLUSTER_LIST</span><span class="p">(</span><span class="n">on_off_switch_clusters</span><span class="p">,</span>
<span class="w">        </span><span class="n">on_off_switch_attr_list</span><span class="p">,</span><span class="w"> </span><span class="n">basic_attr_list</span><span class="p">,</span><span class="w"> </span><span class="n">identify_attr_list</span><span class="p">);</span>
</pre></div>
</div>
<p>You can read more about this step in the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/using_zigbee__z_c_l.html#att_declaration">Declaring attributes</a> section of the ZBOSS stack documentation.</p>
</li>
<li><p>Choose and declare the endpoint for the On/Off Switch device.
For example:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Exemplary 11. endpoint will be used for On/Off Switch cluster</span>
<span class="cp">#define ON_OFF_SWITCH_ENDPOINT          11</span>

<span class="n">ZB_HA_DECLARE_ON_OFF_SWITCH_EP</span><span class="p">(</span><span class="n">on_off_switch_ep</span><span class="p">,</span><span class="w"> </span><span class="n">ON_OFF_SWITCH_ENDPOINT</span><span class="p">,</span><span class="w"> </span><span class="n">on_off_switch_clusters</span><span class="p">);</span>
</pre></div>
</div>
<p>Every cluster in the On/Off cluster list that you have declared in the previous step is going to use the same endpoint.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Every endpoint has an associated Simple Descriptor, which contains a variety of information, such as the application profile identifier, the number of input and output clusters, or the device version.
Simple Descriptors are used to find and identify specific devices in the Zigbee network, for example to bind a light switch with a light bulb.
Declaring an endpoint for a device (in this case, the On/Off Switch device) actually defines a Simple Descriptor for the endpoint.
You can read more about Simple Descriptors in the official <a class="reference external" href="https://zigbeealliance.org/wp-content/uploads/2019/12/07-5123-06-zigbee-cluster-library-specification.pdf">Zigbee Cluster Library specification</a> from <a class="reference external" href="https://csa-iot.org">Connectivity Standards Alliance</a>.</p>
</div>
<p>You can read more about this step in the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/using_zigbee__z_c_l.html#endpoint_dec">Declaring endpoint</a> and <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/using_zigbee__z_c_l.html#simple_desc_declaration">Declaring simple descriptors</a> sections of the ZBOSS stack documentation.</p>
</li>
<li><p>Create an application context with all declared endpoints, given that the Zigbee template sample declares the device context for a single endpoint.
Modify this declaration, so that the device can have another endpoint for the On/Off device:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ZBOSS_DECLARE_DEVICE_CTX_2_EP</span><span class="p">(</span><span class="n">app_template_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">on_off_switch_ep</span><span class="p">,</span><span class="w"> </span><span class="n">app_template_ep</span><span class="p">);</span>
</pre></div>
</div>
<p>You can read more about this step in the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/using_zigbee__z_c_l.html#zigbee_device_context_dec">Declaring Zigbee device context</a> and <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/using_zigbee__z_c_l.html#zigbee_device_context_mult_ep_dec">Declaring Zigbee device context with multiple endpoints</a> sections of the ZBOSS stack documentation.</p>
</li>
<li><p>Make sure that the device context is registered in the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, within the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group__af__management__service.html#ga2ba409e0ae3e25032b673a5f85859a45">ZB_AF_REGISTER_DEVICE_CTX</a> macro:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ZB_AF_REGISTER_DEVICE_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app_template_ctx</span><span class="p">);</span>
</pre></div>
</div>
<p>This creates a link between the application device context and the internal ZBOSS structures.
You can read more about this step in the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/using_zigbee__z_c_l.html#register_zigbee_device">Registering device context</a> section of the ZBOSS stack documentation.</p>
</li>
</ol>
</section>
<section id="add-temperature-sensor-device">
<span id="ug-zigee-adding-clusters-add-temp"></span><h3><a class="toc-backref" href="#id10">Add Temperature Sensor device</a><a class="headerlink" href="#add-temperature-sensor-device" title="Permalink to this heading"></a></h3>
<p>The process of adding Temperature Sensor device is similar to <a class="reference internal" href="#ug-zigee-adding-clusters-add-switch"><span class="std std-ref">adding the On/Off switch device</span></a>.</p>
<p>To create a Temperature Sensor device, we are going to declare the following clusters:</p>
<ul class="simple">
<li><p>Identify and Basic - These clusters are already declared in the Zigbee template sample.</p></li>
<li><p>Temperature Measurement - This cluster we are going to create manually.</p></li>
</ul>
<p>This time, we are going to use the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group__ha__temperature__sensor.html#ga1baeb195bbce720ee97cf9c879726cbb">ZB_HA_DECLARE_TEMPERATURE_SENSOR_CLUSTER_LIST</a> macro.</p>
<p>Complete the following steps:</p>
<ol class="arabic">
<li><p>In the <code class="file docutils literal notranslate"><span class="pre">main.c</span></code> file of the copied template sample, extend the <code class="docutils literal notranslate"><span class="pre">zb_device_ctx</span></code> structure with the Temperature Measurement attributes and declare the attributes list.</p>
<p>In case of Temperature Measurement cluster, variables needed to hold its attributes are declared in the <code class="docutils literal notranslate"><span class="pre">zb_zcl_temp_measurement_attrs_t</span></code> structure, which is defined in <code class="file docutils literal notranslate"><span class="pre">addons/zcl/zb_zcl_temp_measurement_addons.h</span></code>.
Some of clusters have its attributes combined into helper structures in <code class="file docutils literal notranslate"><span class="pre">addons/zcl/zb_zcl_*_addons.h</span></code>.
The following snippet shows how to include the header and add a new field in <code class="docutils literal notranslate"><span class="pre">zb_device_ctx</span></code>, and then declare the attribute list:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;addons/zcl/zb_zcl_temp_measurement_addons.h&gt;</span>


<span class="k">struct</span><span class="w"> </span><span class="nc">zb_device_ctx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zb_zcl_basic_attrs_t</span><span class="w">            </span><span class="n">basic_attr</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_zcl_identify_attrs_t</span><span class="w">         </span><span class="n">identify_attr</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_uint8_t</span><span class="w">                      </span><span class="n">on_off_switch_type_attr</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_uint8_t</span><span class="w">                      </span><span class="n">on_off_switch_actions_attr</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_zcl_temp_measurement_attrs_t</span><span class="w"> </span><span class="n">temp_measure_attrs</span><span class="p">;</span>
<span class="p">};</span>


<span class="n">ZB_ZCL_DECLARE_TEMP_MEASUREMENT_ATTRIB_LIST</span><span class="p">(</span><span class="n">temp_measurement_attr_list</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">&amp;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">temp_measure_attrs</span><span class="p">.</span><span class="n">measure_value</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">&amp;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">temp_measure_attrs</span><span class="p">.</span><span class="n">min_measure_value</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">&amp;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">temp_measure_attrs</span><span class="p">.</span><span class="n">max_measure_value</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">&amp;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">temp_measure_attrs</span><span class="p">.</span><span class="n">tolerance</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Create a Temperature Sensor device by declaring its cluster list using Basic, Identify, and the newly created Temperature Measurement clusters:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ZB_HA_DECLARE_TEMPERATURE_SENSOR_CLUSTER_LIST</span><span class="p">(</span><span class="n">temperature_sensor_clusters</span><span class="p">,</span><span class="w"> </span><span class="n">basic_attr_list</span><span class="p">,</span><span class="w"> </span><span class="n">identify_attr_list</span><span class="p">,</span><span class="w"> </span><span class="n">temp_measurement_attr_list</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Choose and declare the endpoint for the Temperature Sensor device:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define TEMPERATURE_SENSOR_ENDPOINT  12</span>

<span class="n">ZB_HA_DECLARE_TEMPERATURE_SENSOR_EP</span><span class="p">(</span><span class="n">temperature_sensor_ep</span><span class="p">,</span><span class="w"> </span><span class="n">TEMPERATURE_SENSOR_ENDPOINT</span><span class="p">,</span><span class="w"> </span><span class="n">temperature_sensor_clusters</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Declare the device context for the created endpoint by modifying the device context declaration, so that the device can have another endpoint:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ZBOSS_DECLARE_DEVICE_CTX_3_EP</span><span class="p">(</span><span class="n">app_template_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">temperature_sensor_ep</span><span class="p">,</span><span class="w"> </span><span class="n">on_off_switch_ep</span><span class="p">,</span><span class="w"> </span><span class="n">app_template_ep</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
<p>At this point, we have added On/Off Switch and Temperature Sensor functionalities to the application.</p>
</section>
</section>
<section class="numbered-step" id="verify-cluster-changes">
<span id="ug-zigee-adding-clusters-testing"></span><h2><a class="toc-backref" href="#id11">Verify cluster changes</a><a class="headerlink" href="#verify-cluster-changes" title="Permalink to this heading"></a></h2>
<p>To verify the existence of the On/Off Switch and Temperature Sensor clusters in the device, we are going to send ZDO commands to read Simple Descriptors.
For this purpose, we are going to use the <a class="reference internal" href="../../samples/zigbee/network_coordinator/README.html#zigbee-network-coordinator-sample"><span class="std std-ref">Zigbee network coordinator</span></a> to create a simple Zigbee network with the node that is programmed with the extended application.</p>
<section id="prepare-network-coordinator-for-testing">
<h3><a class="toc-backref" href="#id12">Prepare network coordinator for testing</a><a class="headerlink" href="#prepare-network-coordinator-for-testing" title="Permalink to this heading"></a></h3>
<p>To prepare the network coordinator for testing the newly extended application based on the Zigbee template, complete the following steps:</p>
<ol class="arabic">
<li><p>Make sure you meet the requirements to use the <a class="reference internal" href="../../samples/zigbee/network_coordinator/README.html#zigbee-network-coordinator-sample"><span class="std std-ref">Zigbee network coordinator</span></a> sample.</p></li>
<li><p>Enable the Zigbee shell in the network coordinator sample by adding the following line to <code class="file docutils literal notranslate"><span class="pre">network_coordinator/prj.conf</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONFIG_ZIGBEE_SHELL</span><span class="o">=</span><span class="n">y</span>
</pre></div>
</div>
</li>
<li><p>Build the sample and program it to the development kit.</p></li>
<li><p>Open the serial port and issue the <code class="docutils literal notranslate"><span class="pre">help</span></code> command.
The following output appears:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">help</span>
<span class="n">Please</span> <span class="n">press</span> <span class="n">the</span> <span class="o">&lt;</span><span class="n">Tab</span><span class="o">&gt;</span> <span class="n">button</span> <span class="n">to</span> <span class="n">see</span> <span class="nb">all</span> <span class="n">available</span> <span class="n">commands</span><span class="o">.</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">use</span> <span class="n">the</span> <span class="o">&lt;</span><span class="n">Tab</span><span class="o">&gt;</span> <span class="n">button</span> <span class="n">to</span> <span class="n">prompt</span> <span class="ow">or</span> <span class="n">auto</span><span class="o">-</span><span class="n">complete</span> <span class="nb">all</span> <span class="n">commands</span> <span class="ow">or</span> <span class="n">its</span> <span class="n">subcommands</span><span class="o">.</span>
<span class="n">You</span> <span class="n">can</span> <span class="k">try</span> <span class="n">to</span> <span class="n">call</span> <span class="n">commands</span> <span class="k">with</span> <span class="o">&lt;-</span><span class="n">h</span><span class="o">&gt;</span> <span class="ow">or</span> <span class="o">&lt;--</span><span class="n">help</span><span class="o">&gt;</span> <span class="n">parameter</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>

<span class="n">Shell</span> <span class="n">supports</span> <span class="n">following</span> <span class="n">meta</span><span class="o">-</span><span class="n">keys</span><span class="p">:</span>
<span class="n">Ctrl</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="n">key</span> <span class="n">from</span><span class="p">:</span> <span class="n">abcdefklnpuw</span><span class="p">)</span>
<span class="n">Alt</span>  <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="n">key</span> <span class="n">from</span><span class="p">:</span> <span class="n">bf</span><span class="p">)</span>
<span class="n">Please</span> <span class="n">refer</span> <span class="n">to</span> <span class="n">shell</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">more</span> <span class="n">details</span><span class="o">.</span>

<span class="n">Available</span> <span class="n">commands</span><span class="p">:</span>
<span class="n">bdb</span>                <span class="p">:</span><span class="n">Base</span> <span class="n">device</span> <span class="n">behaviour</span> <span class="n">manipulation</span><span class="o">.</span>
<span class="n">clear</span>              <span class="p">:</span><span class="n">Clear</span> <span class="n">screen</span><span class="o">.</span>
<span class="n">debug</span>              <span class="p">:</span><span class="n">Return</span> <span class="n">state</span> <span class="n">of</span> <span class="n">debug</span> <span class="n">mode</span><span class="o">.</span>
<span class="n">device</span>             <span class="p">:</span><span class="n">Device</span> <span class="n">commands</span>
<span class="n">devmem</span>             <span class="p">:</span><span class="n">Read</span><span class="o">/</span><span class="n">write</span> <span class="n">physical</span> <span class="n">memory</span><span class="s2">&quot;devmem address [width [value]]&quot;</span>
<span class="n">flash</span>              <span class="p">:</span><span class="n">Flash</span> <span class="n">shell</span> <span class="n">commands</span>
<span class="n">help</span>               <span class="p">:</span><span class="n">Prints</span> <span class="n">the</span> <span class="n">help</span> <span class="n">message</span><span class="o">.</span>
<span class="n">history</span>            <span class="p">:</span><span class="n">Command</span> <span class="n">history</span><span class="o">.</span>
<span class="n">kernel</span>             <span class="p">:</span><span class="n">Kernel</span> <span class="n">commands</span>
<span class="n">nbr</span>                <span class="p">:</span><span class="n">Zigbee</span> <span class="n">neighbor</span> <span class="n">table</span><span class="o">.</span>
<span class="n">nrf_clock_control</span>  <span class="p">:</span><span class="n">Clock</span> <span class="n">control</span> <span class="n">commmands</span>
<span class="n">nvram</span>              <span class="p">:</span><span class="n">Zigbee</span> <span class="n">NVRAM</span> <span class="n">manipulation</span><span class="o">.</span>
<span class="n">resize</span>             <span class="p">:</span><span class="n">Console</span> <span class="n">gets</span> <span class="n">terminal</span> <span class="n">screen</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">assumes</span> <span class="n">default</span> <span class="ow">in</span>
                    <span class="k">case</span> <span class="n">the</span> <span class="n">readout</span> <span class="n">fails</span><span class="o">.</span> <span class="n">It</span> <span class="n">must</span> <span class="n">be</span> <span class="n">executed</span> <span class="n">after</span> <span class="n">each</span>
                    <span class="n">terminal</span> <span class="n">width</span> <span class="n">change</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">correct</span> <span class="n">text</span> <span class="n">display</span><span class="o">.</span>
<span class="n">sensor</span>             <span class="p">:</span><span class="n">Sensor</span> <span class="n">commands</span>
<span class="n">shell</span>              <span class="p">:</span><span class="n">Useful</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Unix</span><span class="o">-</span><span class="n">like</span> <span class="n">shell</span> <span class="n">commands</span><span class="o">.</span>
<span class="n">version</span>            <span class="p">:</span><span class="n">Print</span> <span class="n">firmware</span> <span class="n">version</span>
<span class="n">zcl</span>                <span class="p">:</span><span class="n">ZCL</span> <span class="n">subsystem</span> <span class="n">commands</span><span class="o">.</span>
<span class="n">zdo</span>                <span class="p">:</span><span class="n">ZDO</span> <span class="n">manipulation</span><span class="o">.</span>
<span class="n">zscheduler</span>         <span class="p">:</span><span class="n">Zigbee</span> <span class="n">scheduler</span> <span class="n">manipulation</span><span class="o">.</span>
</pre></div>
</div>
</li>
</ol>
<p>This output means that the Zigbee shell is enabled on the network coordinator node device.
You can read more about the Zigbee shell on its <a class="reference internal" href="../../libraries/zigbee/shell.html#lib-zigbee-shell"><span class="std std-ref">documentation page</span></a>.</p>
</section>
<section id="run-the-extended-application">
<h3><a class="toc-backref" href="#id13">Run the extended application</a><a class="headerlink" href="#run-the-extended-application" title="Permalink to this heading"></a></h3>
<p>We are now going to add the extended application node device to the Zigbee network.
Complete the following steps:</p>
<ol class="arabic">
<li><p>Make sure that the network coordinator node device is running.</p></li>
<li><p>Build the extended application and program it to a compatible development kit, which is one of the development kits compatible with the template sample.</p></li>
<li><p>Connect the kit to the computer using a USB cable.
The kit is assigned a COM port (Windows) or ttyACM device (Linux), which is visible in the Device Manager.</p></li>
<li><p>Connect to the kit with a terminal emulator (for example, PuTTY).
See <a class="reference internal" href="../../getting_started/testing.html#putty"><span class="std std-ref">How to connect with PuTTY</span></a> for the required settings.</p></li>
<li><p>Observe the output.
The device connects to the Zigbee network when a notification similar to the following one appears:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I</span><span class="p">:</span> <span class="n">Joined</span> <span class="n">network</span> <span class="n">successfully</span> <span class="p">(</span><span class="n">Extended</span> <span class="n">PAN</span> <span class="n">ID</span><span class="p">:</span> <span class="n">f4ce36e005691785</span><span class="p">,</span> <span class="n">PAN</span> <span class="n">ID</span><span class="p">:</span> <span class="mh">0xf7a7</span><span class="p">)</span>
</pre></div>
</div>
<p>The Extended PAN ID and the PAN ID in your notification will be different.</p>
</li>
</ol>
</section>
<section id="verify-cluster-operation">
<h3><a class="toc-backref" href="#id14">Verify cluster operation</a><a class="headerlink" href="#verify-cluster-operation" title="Permalink to this heading"></a></h3>
<p>Reading Simple Descriptors that we have implemented when <a class="reference internal" href="#ug-zigee-adding-clusters-adding-clusters"><span class="std std-ref">adding new clusters</span></a> can help us verify that everything is working as it should.
You can read the descriptors in different ways, but for the purpose of this guide we are going to use Zigbee Device Object commands (ZDO commands) issued from the network coordinator node with the Zigbee shell enabled.
ZDO is an interface for accessing lower layers of the Zigbee network.
Issuing ZDO commands allows us to check different information about the network.</p>
<p>For this guide, you can use one of the following options:</p>
<ul class="simple">
<li><p>Issue ZDO commands to find the specific cluster in the Zigbee network, if you don’t know the device’s short address.</p></li>
<li><p>Issue ZDO commands to read the list of clusters contained on a device, if you know the device’s short address.</p></li>
</ul>
<p>Both options are described in the following sections.</p>
<section id="looking-for-a-specific-cluster-in-the-zigbee-network">
<h4>Looking for a specific cluster in the Zigbee network<a class="headerlink" href="#looking-for-a-specific-cluster-in-the-zigbee-network" title="Permalink to this heading"></a></h4>
<p>You can send a match descriptor request when you want to find a specific cluster in the network.
This request is a broadcast command that expects profile and cluster IDs as return values.
When using the network coordinator node with the Zigbee shell enabled, you can send the ZDO match descriptor request in the following way:</p>
<ol class="arabic">
<li><p>Make sure that the network coordinator is still connected with the serial port.</p></li>
<li><p>Issue the <code class="docutils literal notranslate"><span class="pre">zdo</span> <span class="pre">help</span></code> command to print the information about the <code class="docutils literal notranslate"><span class="pre">zdo</span></code> commands, including the match descriptor command.
The following output appears:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="n">match_desc</span> <span class="o">-</span> <span class="n">Send</span> <span class="n">match</span> <span class="n">descriptor</span> <span class="n">request</span><span class="o">.</span>
        <span class="n">Usage</span><span class="p">:</span> <span class="n">match_desc</span> <span class="o">&lt;</span><span class="n">h</span><span class="p">:</span><span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">destination_address</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">h</span><span class="p">:</span><span class="n">requested</span>
        <span class="n">address</span><span class="o">/</span><span class="nb">type</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">h</span><span class="p">:</span><span class="n">profile</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">d</span><span class="p">:</span><span class="n">number</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">clusters</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">h</span><span class="p">:</span><span class="nb">input</span>
        <span class="n">cluster</span> <span class="n">IDs</span><span class="o">&gt;</span> <span class="o">...</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">d</span><span class="p">:</span><span class="n">number</span> <span class="n">of</span> <span class="n">output</span> <span class="n">clusters</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">h</span><span class="p">:</span><span class="n">output</span> <span class="n">cluster</span>
        <span class="n">IDs</span><span class="o">&gt;</span> <span class="o">...</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">t</span> <span class="o">|</span> <span class="o">--</span><span class="n">timeout</span> <span class="n">d</span><span class="p">:</span><span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">answers</span><span class="p">]</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>Send the <a class="reference internal" href="../../libraries/zigbee/shell.html#zdo-match-desc"><span class="std std-ref">zdo match_desc</span></a> command to find a device with the On/Off cluster (ID: <code class="docutils literal notranslate"><span class="pre">0x0006</span></code>) from the Home Automation profile (ID: <code class="docutils literal notranslate"><span class="pre">0x0104</span></code>) using the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">zdo match_desc 0xfffd 0xfffd 0x0104 0 1 0x06</span>
</pre></div>
</div>
<p>The following output appears:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Sending broadcast request.</span>

<span class="go">src_addr=8083 ep=11</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="reading-a-clusters-list-of-a-specific-zigbee-node">
<h4>Reading a clusters list of a specific Zigbee node<a class="headerlink" href="#reading-a-clusters-list-of-a-specific-zigbee-node" title="Permalink to this heading"></a></h4>
<p>To read the cluster list existing on a Zigbee node, you can use the Simple Descriptor Request command.
This command requires the short address and the endpoint as arguments.</p>
<p>Complete the following steps to read the cluster list of a Zigbee node:</p>
<ol class="arabic">
<li><p>Send the match descriptor request to learn the short address of device, as described in <a class="reference internal" href="#looking-for-a-specific-cluster-in-the-zigbee-network">Looking for a specific cluster in the Zigbee network</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">zdo match_desc 0xfffd 0xfffd 0x0104 0 1 0x06</span>
</pre></div>
</div>
<p>The following output appears, where <code class="docutils literal notranslate"><span class="pre">8083</span></code> is the short address of the Zigbee node and <code class="docutils literal notranslate"><span class="pre">11</span></code> is the endpoint number of the On/Off switch device:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Sending broadcast request.</span>

<span class="go">src_addr=8083 ep=11</span>
</pre></div>
</div>
<p>Alternatively, you can check the short address by looking at the network coordinator logs showed during device association or by sniffing the communication and reading packets in Wireshark (see <a class="reference external" href="https://infocenter.nordicsemi.com/topic/ug_sniffer_802154/UG/sniffer_802154/configuring_sniffer_802154_zigbee.html">Configuring Wireshark for Zigbee</a>).</p>
</li>
<li><p>Send the <a class="reference internal" href="../../libraries/zigbee/shell.html#zdo-simple-desc-req"><span class="std std-ref">zdo simple_desc_req</span></a> command to the Zigbee node using the short address and the endpoint number:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">zdo simple_desc_req 0x8083 11</span>
</pre></div>
</div>
<p>The output similar to the following one appears:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">src_addr=0x8083 ep=11 profile_id=0x0104 app_dev_id=0x0 app_dev_ver=0x0</span>
<span class="go">in_clusters=0x0000,0x0003,0x0007 out_clusters=0x0006,0x0005,0x0004,0x0003</span>
</pre></div>
</div>
<p>In this notification, the simple descriptor contains Basic Cluster, Identify Cluster and On/Off Switch Configuration with server roles (<code class="docutils literal notranslate"><span class="pre">in_clusters</span></code>) and Identify, Groups, Scenes, and On/Off configured with client roles (<code class="docutils literal notranslate"><span class="pre">out_clusters</span></code>).</p>
</li>
</ol>
</section>
</section>
</section>
<section id="further-expanding-the-custom-application">
<h2><a class="toc-backref" href="#id15">Further expanding the custom application</a><a class="headerlink" href="#further-expanding-the-custom-application" title="Permalink to this heading"></a></h2>
<p>You can further expand the application with more features, such as OTA support.</p>
<section id="adding-ota">
<span id="ug-zigee-adding-clusters-ota"></span><h3><a class="toc-backref" href="#id16">Adding OTA</a><a class="headerlink" href="#adding-ota" title="Permalink to this heading"></a></h3>
<p>To extend the sample with OTA support, we would have to complete steps similar to <a class="reference internal" href="#ug-zigee-adding-clusters-adding-clusters"><span class="std std-ref">adding On/Off Switch and Temperature Sensor functionalities</span></a>.
Then, we would have to implement the ZCL device callback to control the process of collecting chunks of new firmware.
This is described more broadly in the following sections.</p>
<p>Fortunately, we can use the <a class="reference internal" href="../../libraries/zigbee/zigbee_fota.html#lib-zigbee-fota"><span class="std std-ref">Zigbee FOTA</span></a> library to handle the majority of these implementation steps.
To add OTA support to the extended application, follow the steps in <a class="reference internal" href="configuring_libraries.html#ug-zigbee-configuring-components-ota"><span class="std std-ref">Configuring Zigbee FOTA</span></a>.</p>
</section>
<section id="passing-zcl-events-to-the-application">
<span id="ug-zigee-adding-clusters-passing-events"></span><h3><a class="toc-backref" href="#id17">Passing ZCL events to the application</a><a class="headerlink" href="#passing-zcl-events-to-the-application" title="Permalink to this heading"></a></h3>
<p>Declaring and registering a set of clusters that defines a Zigbee node makes these clusters discoverable across the Zigbee network and ready to communicate with another nodes.
For example, the communication between a light switch node and a light bulb node uses ZCL commands to change the attributes of the On/Off device embedded in the light bulb.
Altering the attribute does nothing more than changing values of a specific variable.
The application is supposed to react to these changes and produce appropriate behavior, but we need to inform it about these changes first.</p>
<p>To inform the application about attributes changes, you can pass ZCL events to it with a callback that follows generic callback definition (referred to as <em>ZCL callback</em>).
This is shown in the following snippet:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="n">zb_callback_t</span><span class="p">)(</span><span class="n">zb_uint8_t</span><span class="w"> </span><span class="n">param</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">param</span></code> argument passed to the callback contains information about the changed attributes.
This argument is actually a ZBOSS buffer that contains the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group___z_b___z_c_l___i_n_i_t_i_a_l_i_z_a_t_i_o_n.html#ga0dfcc989252b93252f8bb1d27d2639fa">zb_zcl_device_callback_param_t</a> structure whose definition fragment is as follows:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* For the full definition please refer to zboss_api_zcl.h */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">zb_zcl_device_callback_param_s</span>
<span class="p">{</span>
<span class="w">        </span><span class="cm">/** Type of device callback */</span>
<span class="w">        </span><span class="n">zb_zcl_device_callback_id_t</span><span class="w"> </span><span class="n">device_cb_id</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_uint8_t</span><span class="w"> </span><span class="n">endpoint</span><span class="p">;</span>
<span class="w">        </span><span class="n">zb_zcl_attr_access_t</span><span class="w"> </span><span class="n">attr_type</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/** Return status (see zb_ret_t) */</span>
<span class="w">        </span><span class="n">zb_ret_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/** Callback custom data */</span>
<span class="w">        </span><span class="k">union</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">                </span><span class="n">zb_zcl_set_attr_value_param_t</span><span class="w">  </span><span class="n">set_attr_value_param</span><span class="p">;</span>
<span class="w">                </span><span class="cp">#if defined (ZB_ZCL_SUPPORT_CLUSTER_ON_OFF)</span>
<span class="w">                </span><span class="cm">/* Off with effect command, On/Off cluster */</span>
<span class="w">                </span><span class="n">zb_zcl_on_off_set_effect_value_param_t</span><span class="w">  </span><span class="n">on_off_set_effect_value_param</span><span class="p">;</span>
<span class="w">                </span><span class="cm">/* */</span>
<span class="w">                </span><span class="cp">#endif</span>
<span class="w">                </span><span class="cp">#if defined(ZB_ZCL_SUPPORT_CLUSTER_IDENTIFY)</span>
<span class="w">                </span><span class="n">zb_zcl_identify_effect_value_param_t</span><span class="w">  </span><span class="n">identify_effect_value_param</span><span class="p">;</span>
<span class="w">                </span><span class="cp">#endif</span>

<span class="w">                </span><span class="cm">/* .</span>
<span class="cm">                   .</span>
<span class="cm">                   .</span>
<span class="cm">                */</span>

<span class="w">                </span><span class="n">zb_zcl_device_cmd_generic_param_t</span><span class="w"> </span><span class="n">gnr</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">cb_param</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">zb_zcl_device_callback_param_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Both the On/Off Switch device and the Temperature Sensor device have client roles.
For this reason, their attributes are not supposed to change.
To show how you can use the ZCL event, read the following section.</p>
<section id="reading-device-callback-parameters-from-a-zboss-buffer">
<h4>Reading device callback parameters from a ZBOSS buffer<a class="headerlink" href="#reading-device-callback-parameters-from-a-zboss-buffer" title="Permalink to this heading"></a></h4>
<p>The ZCL callback implemented in the <a class="reference internal" href="../../libraries/zigbee/zigbee_fota.html#lib-zigbee-fota"><span class="std std-ref">Zigbee FOTA</span></a> library is a good example of how to use the ZCL event.</p>
<p>To read the device callback parameters from a ZBOSS buffer, complete the following steps:</p>
<ol class="arabic">
<li><p>In the <code class="file docutils literal notranslate"><span class="pre">main.c</span></code> file of the copied template sample, use the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group___z_b___z_c_l___i_n_i_t_i_a_l_i_z_a_t_i_o_n.html#ga0dfcc989252b93252f8bb1d27d2639fa">zb_zcl_device_callback_param_t</a> structure to get the ZCL callback parameters from the buffer in the following manner:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">zb_zcl_device_callback_param_t</span><span class="w"> </span><span class="o">*</span><span class="n">device_cb_param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZB_BUF_GET_PARAM</span><span class="p">(</span><span class="n">bufid</span><span class="p">,</span><span class="w"> </span><span class="n">zb_zcl_device_callback_param_t</span><span class="p">);</span>
</pre></div>
</div>
<p>Once the parameters are obtained, the application can use them to perform some action based on a new attribute values.</p>
</li>
<li><p>Make the application check the callback ID by reading the appropriate field from the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group___z_b___z_c_l___i_n_i_t_i_a_l_i_z_a_t_i_o_n.html#gad27454b213ce8a00540ebc75288966ad">zb_zcl_device_callback_id_t</a> structure.
For example, the Zigbee FOTA library uses the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group___z_b___z_c_l___i_n_i_t_i_a_l_i_z_a_t_i_o_n.html#gga35caa2e3a9ef37535b1f75e0fe919266a8a87688c465e80b46ad821741a60fe84">ZB_ZCL_OTA_UPGRADE_VALUE_CB_ID</a> macro:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_cb_param</span><span class="o">-&gt;</span><span class="n">device_cb_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ZB_ZCL_OTA_UPGRADE_VALUE_CB_ID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Depending on the device callback ID, different data is passed to the callback and held by the <code class="docutils literal notranslate"><span class="pre">cb_param</span></code> field of <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group___z_b___z_c_l___i_n_i_t_i_a_l_i_z_a_t_i_o_n.html#ga0dfcc989252b93252f8bb1d27d2639fa">zb_zcl_device_callback_param_t</a>.
In general, the data associated with the callback ID is contained in the <code class="docutils literal notranslate"><span class="pre">set_attr_value_param</span></code> field of <code class="docutils literal notranslate"><span class="pre">cb_param</span></code>, but some clusters have their data structure already defined.
For example, OTA uses <code class="docutils literal notranslate"><span class="pre">ota_value_param</span></code> fields, as shown in the following snippet:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">zb_zcl_ota_upgrade_value_param_t</span><span class="w"> </span><span class="o">*</span><span class="n">ota_upgrade_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">device_cb_param</span><span class="o">-&gt;</span><span class="n">cb_param</span><span class="p">.</span><span class="n">ota_value_param</span><span class="p">);</span>
</pre></div>
</div>
<p>To see the field usage associated with other clusters, refer to the <a class="reference internal" href="../../samples/zigbee/light_bulb/README.html#zigbee-light-bulb-sample"><span class="std std-ref">Zigbee: Light bulb</span></a> sample.</p>
</li>
<li><p>Make the ZCL callback pass the status of its execution to the caller by setting the appropriate return status in the <code class="docutils literal notranslate"><span class="pre">status</span></code> field of the <a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/zboss/3.11.2.1/group___z_b___z_c_l___i_n_i_t_i_a_l_i_z_a_t_i_o_n.html#ga0dfcc989252b93252f8bb1d27d2639fa">zb_zcl_device_callback_param_t</a> structure passed to the callback:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">device_cb_param</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RET_OK</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="other_ecosystems.html" class="btn btn-neutral float-right" title="Configuring Zigbee samples for other ecosystems" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configuring_zboss_traces.html" class="btn btn-neutral" title="Configuring ZBOSS traces in nRF Connect SDK" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2019-2023, Nordic Semiconductor.
      Last updated on Mar 20, 2023.

    </p>
</td>
<td id="nordiclogo">
  <a href="https://www.nordicsemi.com/"><img src="../../_static/images/nordic-logo.png" border="0"/></a>
</td>
</tr>
</table>
  </div> 


</footer>

<div id="scroll-container">
  <button type="button" id="scroll-btn" class="btn">
    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="#fff"/></svg>
  </button>
</div>

<script>
  const scrollBtn = document.querySelector("#scroll-btn");

  document.addEventListener("scroll", () => {
    if (window.scrollY > 400) {
          scrollBtn.style.visibility = "visible";
      } else {
          scrollBtn.style.visibility = "hidden";
      }
  });

  scrollBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
  });
</script>
        </div>
      </div>
    </section>
  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> nRF Connect SDK</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <div class="rst-other-version ncs">
        <a href="../../../nrf/index.html">nRF Connect SDK</a>
      </div>
      
      <div class="rst-other-version nrfx">
        <a href="../../../nrfx/index.html">nrfx</a>
      </div>
      
      <div class="rst-other-version nrfxlib">
        <a href="../../../nrfxlib/README.html">nrfxlib</a>
      </div>
      
      <div class="rst-other-version zephyr">
        <a href="../../../zephyr/index.html">Zephyr Project</a>
      </div>
      
      <div class="rst-other-version mcuboot">
        <a href="../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      
      <div class="rst-other-version tfm">
        <a href="../../../tfm/index.html">Trusted Firmware-M</a>
      </div>
      
      <div class="rst-other-version matter">
        <a href="../../../matter/index.html">Matter</a>
      </div>
      
      <div class="rst-other-version kconfig">
        <a href="../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>