<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device Firmware Upgrade module &mdash; nRF Connect SDK 2.3.99 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/nordic.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/nrf.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" /> 
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=G-ZPVZRKFQJR"></script>
        <script src="../../../_static/js/ga-tracker.js"></script>
        <script data-culture="EN" id="CookieConsent" type="text/javascript" src="https://policy.app.cookieinformation.com/uc.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/js/theme.js"></script>
<script
  type="text/javascript"
  src="../../../_static/js/ncs.js"
></script>
<script src="../../../_static/js/bootstrap.bundle.min.js"></script>

    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Failsafe module" href="failsafe.html" />
    <link rel="prev" title="Device description module" href="dev_descr.html" />
<link
  href="../../../_static/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link
  rel="shortcut icon"
  href="../../../_static/images/favicon.ico"
/>

</head>

<body class="wy-body-for-nav">
<div class="announcement"></div>
<div class="d-print-none ncs-header">
  <div class="container-xl ncs-header-top">
    <div class="row h-100">
      <div class="d-none d-md-block col-2">
        <div class="bg-white py-4 px-3 ml-2 ncs-header-logo">
          <img
            class="ncs-header-logo"
            src="../../../_static/images/nordic-logo.png"
            alt=""
          />
        </div>
      </div>
      <div
        class="col-8 col-md-7 pl-md-4 d-flex align-self-center justify-content-center"
      >
        <form class="w-75" action="../../../search.html" method="get">
          <div class="form-group">
            <input
              type="text"
              name="q"
              class="ncs-search-input form-control"
              placeholder="Search all docs..."
            />
          </div>
        </form>
      </div>
      <div class="col-4 col-md-3 d-md-block p-3 text-end">
        <div class="dropdown">
          <button
            class="btn dropdown-toggle ncs-btn-versions"
            type="button"
            id="dropdownMenuButton1"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <span class="d-none d-md-inline">nRF Connect SDK</span>
            <span id="ncsversion" class="d-inline"></span>
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="ncs-header-nav">
    <div class="container-xl">
      <div class="row">
        <div class="col col-12 d-flex justify-content-center">
          <nav class="navbar navbar-dark navbar-expand-lg p-0">
            <span class="navbar-brand d-block d-lg-none py-2 pl-1"
              >Documentation sets</span
            >
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarNavAltMarkup"
              aria-controls="navbarNavAltMarkup"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <ul class="navbar-nav">
                <li class="nav-item active py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../nrf/index.html"
                    >nRF Connect SDK</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../nrfx/index.html"
                    >nrfx</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../nrfxlib/README.html"
                    >nrfxlib</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../zephyr/index.html"
                    >Zephyr Project</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../mcuboot/wrapper.html"
                    >MCUboot</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../tfm/index.html"
                    >Trusted Firmware-M</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../matter/index.html"
                    >Matter</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="nav-item  py-1 px-3">
                  <a
                    class="nav-link"
                    href="../../../../kconfig/index.html"
                    >Kconfig Reference</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
              </ul>
            </div>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> nRF Connect SDK
          </a>
              <div class="version">
                2.3.99
              </div>
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_model.html">Development model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app_dev.html">Application development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ecosystem_integration.html">Ecosystems integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nrf91.html">Working with nRF91 Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nrf70.html">Working with nRF70 Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nrf53.html">Working with nRF53 Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nrf52.html">Working with nRF52 Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../protocols.html">Protocols</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../applications.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../connectivity_bridge/README.html">Connectivity bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../asset_tracker_v2/README.html">nRF9160: Asset Tracker v2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../serial_lte_modem/README.html">nRF9160: Serial LTE modem</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../README.html">nRF Desktop</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../README.html#overview-firmware-architecture">Overview: Firmware architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#user-interface">User interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#configuration">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#building-and-running">Building and running</a></li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#integrating-your-own-hardware">Integrating your own hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#dependencies">Dependencies</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../README.html#application-internal-modules">Application internal modules</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="main.html">Basic module (main)</a></li>
<li class="toctree-l4"><a class="reference internal" href="battery_charger.html">Battery charger module</a></li>
<li class="toctree-l4"><a class="reference internal" href="battery_meas.html">Battery measurement module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_adv.html">Bluetooth LE advertising module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_bond.html">Bluetooth LE bond module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_conn_params.html">Bluetooth LE connection parameters module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_discovery.html">Bluetooth LE discovery module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_latency.html">Bluetooth LE latency module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_passkey.html">Bluetooth LE passkey module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_qos.html">Bluetooth LE Quality of Service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_scan.html">Bluetooth LE scanning module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_state_pm.html">Bluetooth state power manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ble_state.html">Bluetooth LE state module</a></li>
<li class="toctree-l4"><a class="reference internal" href="board.html">Board module</a></li>
<li class="toctree-l4"><a class="reference internal" href="buttons.html">Buttons module</a></li>
<li class="toctree-l4"><a class="reference internal" href="buttons_sim.html">Button simulator module</a></li>
<li class="toctree-l4"><a class="reference internal" href="click_detector.html">Click detector module</a></li>
<li class="toctree-l4"><a class="reference internal" href="config_channel.html">Configuration channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="cpu_meas.html">CPU measurement module</a></li>
<li class="toctree-l4"><a class="reference internal" href="dev_descr.html">Device description module</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Device Firmware Upgrade module</a></li>
<li class="toctree-l4"><a class="reference internal" href="failsafe.html">Failsafe module</a></li>
<li class="toctree-l4"><a class="reference internal" href="fast_pair_app.html">Fast Pair module</a></li>
<li class="toctree-l4"><a class="reference internal" href="fn_keys.html">Function key module</a></li>
<li class="toctree-l4"><a class="reference internal" href="bas.html">GATT Battery Service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="hid_forward.html">HID forward module</a></li>
<li class="toctree-l4"><a class="reference internal" href="hid_state.html">HID state module</a></li>
<li class="toctree-l4"><a class="reference internal" href="hid_state_pm.html">HID state power manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="hids.html">HID Service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="info.html">Info module</a></li>
<li class="toctree-l4"><a class="reference internal" href="led_state.html">LED state module</a></li>
<li class="toctree-l4"><a class="reference internal" href="led_stream.html">LED stream module</a></li>
<li class="toctree-l4"><a class="reference internal" href="leds.html">LEDs module</a></li>
<li class="toctree-l4"><a class="reference internal" href="motion.html">Motion module</a></li>
<li class="toctree-l4"><a class="reference internal" href="passkey.html">Passkey module</a></li>
<li class="toctree-l4"><a class="reference internal" href="power_manager.html">Power manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="nrf_profiler_sync.html">nRF Profiler synchronization module</a></li>
<li class="toctree-l4"><a class="reference internal" href="qos.html">Quality of Service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="selector.html">Selector module</a></li>
<li class="toctree-l4"><a class="reference internal" href="smp.html">Simple Management Protocol module</a></li>
<li class="toctree-l4"><a class="reference internal" href="settings_loader.html">Settings loader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_state_pm.html">USB state power manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_state.html">USB state module</a></li>
<li class="toctree-l4"><a class="reference internal" href="watchdog.html">Watchdog module</a></li>
<li class="toctree-l4"><a class="reference internal" href="wheel.html">Wheel module</a></li>
<li class="toctree-l4"><a class="reference internal" href="constlat.html">Constant latency hotfix module</a></li>
<li class="toctree-l4"><a class="reference internal" href="hfclk_lock.html">High frequency clock lock hotfix module</a></li>
<li class="toctree-l4"><a class="reference internal" href="event_rel_modules.html">Source and sink module lists</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#application-configuration-options">Application configuration options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../README.html#api-documentation">API documentation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../nrf5340_audio/README.html">nRF5340 Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../machine_learning/README.html">nRF Machine Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../matter_weather_station/README.html">Thingy:53: Matter weather station</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../zigbee_weather_station/README.html">Thingy:53: Zigbee weather station</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../samples.html">Samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../drivers.html">Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../libraries/index.html">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../known_issues.html">Known issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software_maturity.html">Software maturity levels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">About this documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">nRF Connect SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../../applications.html">Applications</a></li>
          <li class="breadcrumb-item"><a href="../README.html">nRF Desktop</a></li>
      <li class="breadcrumb-item active">Device Firmware Upgrade module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/applications/nrf_desktop/doc/dfu.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="device-firmware-upgrade-module">
<span id="nrf-desktop-dfu"></span><h1>Device Firmware Upgrade module<a class="headerlink" href="#device-firmware-upgrade-module" title="Permalink to this heading"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#module-events" id="id6">Module events</a></p></li>
<li><p><a class="reference internal" href="#configuration" id="id7">Configuration</a></p></li>
<li><p><a class="reference internal" href="#implementation-details" id="id8">Implementation details</a></p>
<ul>
<li><p><a class="reference internal" href="#protocol-operations" id="id9">Protocol operations</a></p></li>
<li><p><a class="reference internal" href="#writing-data-to-flash" id="id10">Writing data to flash</a></p></li>
<li><p><a class="reference internal" href="#partition-preparation" id="id11">Partition preparation</a></p></li>
</ul>
</li>
</ul>
</div>
<p>Use the DFU module to:</p>
<ul class="simple">
<li><p>Obtain the update image from <a class="reference internal" href="config_channel.html#nrf-desktop-config-channel"><span class="std std-ref">Configuration channel</span></a> and store it in the appropriate flash memory partition.</p></li>
<li><p>Erase the flash memory partition in the background before storing the update image.</p></li>
</ul>
<section id="module-events">
<h2><a class="toc-backref" href="#id6">Module events</a><a class="headerlink" href="#module-events" title="Permalink to this heading"></a></h2>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 15%" />
<col style="width: 8%" />
<col style="width: 22%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Source Module</p></th>
<th class="head"><p>Input Event</p></th>
<th class="head"><p>This Module</p></th>
<th class="head"><p>Output Event</p></th>
<th class="head"><p>Sink Module</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="event_rel_modules.html#nrf-desktop-config-event-sources"><span class="std std-ref">Source modules for config_event</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">config_event</span></code></p></td>
<td rowspan="10"><p><code class="docutils literal notranslate"><span class="pre">dfu</span></code></p></td>
<td rowspan="8"></td>
<td rowspan="8"></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="ble_adv.html#nrf-desktop-ble-adv"><span class="std std-ref">Bluetooth LE advertising module</span></a></p></td>
<td rowspan="2"><p><code class="docutils literal notranslate"><span class="pre">ble_peer_event</span></code></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="ble_state.html#nrf-desktop-ble-state"><span class="std std-ref">Bluetooth LE state module</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="hid_forward.html#nrf-desktop-hid-forward"><span class="std std-ref">HID forward module</span></a></p></td>
<td rowspan="4"><p><code class="docutils literal notranslate"><span class="pre">hid_report_event</span></code></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="hid_state.html#nrf-desktop-hid-state"><span class="std std-ref">HID state module</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="hids.html#nrf-desktop-hids"><span class="std std-ref">HID Service module</span></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="usb_state.html#nrf-desktop-usb-state"><span class="std std-ref">USB state module</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="event_rel_modules.html#nrf-desktop-module-state-event-sources"><span class="std std-ref">Source modules for module_state_event</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">module_state_event</span></code></p></td>
</tr>
<tr class="row-even"><td rowspan="2"></td>
<td rowspan="2"></td>
<td><p><code class="docutils literal notranslate"><span class="pre">config_event</span></code></p></td>
<td><p><a class="reference internal" href="event_rel_modules.html#nrf-desktop-config-event-sinks"><span class="std std-ref">Sink modules for config_event</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">power_manager_restrict_event</span></code></p></td>
<td><p><a class="reference internal" href="power_manager.html#nrf-desktop-power-manager"><span class="std std-ref">Power manager module</span></a></p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the <a class="reference internal" href="../README.html#nrf-desktop-architecture"><span class="std std-ref">Overview: Firmware architecture</span></a> for more information about the event-based communication in the nRF Desktop application and about how to read this table.</p>
</div>
</section>
<section id="configuration">
<h2><a class="toc-backref" href="#id7">Configuration</a><a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h2>
<p>To perform the firmware upgrade, you must enable the bootloader.
You can use the DFU module with either MCUboot or B0 bootloader.
For more information on how to enable the bootloader, see the <a class="reference internal" href="../README.html#nrf-desktop-bootloader"><span class="std std-ref">Bootloader</span></a> documentation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you selected the MCUboot bootloader, the DFU module:</p>
<ul class="simple">
<li><p>Requests the image upgrade after the whole image is transferred over the <a class="reference internal" href="config_channel.html#nrf-desktop-config-channel"><span class="std std-ref">Configuration channel</span></a>.</p></li>
<li><p>Confirms the running image after device reboot.</p></li>
</ul>
</div>
<p>Enable the DFU module using the <a class="reference internal" href="../README.html#config-desktop-app-options"><span class="std std-ref">CONFIG_DESKTOP_CONFIG_CHANNEL_DFU_ENABLE</span></a> option.
It requires the transport option <a class="reference internal" href="../README.html#config-desktop-app-options"><span class="std std-ref">CONFIG_DESKTOP_CONFIG_CHANNEL_ENABLE</span></a> to be selected, as it uses <a class="reference internal" href="config_channel.html#nrf-desktop-config-channel"><span class="std std-ref">Configuration channel</span></a> for the transmission of the update image.</p>
<p>Set the value of <a class="reference internal" href="../README.html#config-desktop-app-options"><span class="std std-ref">CONFIG_DESKTOP_CONFIG_CHANNEL_DFU_SYNC_BUFFER_SIZE</span></a> to specify the size of the sync buffer (in words).
During the DFU, the data is initially stored in the buffer and then it is moved to flash.
The buffer is located in the RAM, so increasing the buffer size increases the RAM usage.
If the buffer is small, the host must perform the DFU progress synchronization more often.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The received update image chunks are stored on the dedicated flash memory partition when the current version of the device firmware is running.
For this reason, make sure that you use configuration with two image partitions.
For more information on configuring the memory layout in the application, see the <a class="reference internal" href="../README.html#nrf-desktop-flash-memory-layout"><span class="std std-ref">Flash memory layout</span></a> documentation.</p>
</div>
</section>
<section id="implementation-details">
<h2><a class="toc-backref" href="#id8">Implementation details</a><a class="headerlink" href="#implementation-details" title="Permalink to this heading"></a></h2>
<p>The DFU module implementation is centered around the transmission and the storage of the update image, and it can be broken down into the following stages:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#protocol-operations">Protocol operations</a> - How the module exchanges information with the host.</p></li>
<li><p><a class="reference internal" href="#partition-preparation">Partition preparation</a> - How the module prepares for receiving an image.</p></li>
</ul>
<p>The firmware transfer operation can also be carried out by <a class="reference internal" href="smp.html#nrf-desktop-ble-smp"><span class="std std-ref">Simple Management Protocol module</span></a>.
The application user must not perform more than one firmware upgrade at a time.
The modification of the data by multiple application modules would result in a broken image that would be rejected by the bootloader.</p>
<section id="protocol-operations">
<h3><a class="toc-backref" href="#id9">Protocol operations</a><a class="headerlink" href="#protocol-operations" title="Permalink to this heading"></a></h3>
<p>The DFU module depends on the <a class="reference internal" href="config_channel.html#nrf-desktop-config-channel"><span class="std std-ref">Configuration channel</span></a> for the correct and secure data transmission between the host and the device.
The module provides a simple protocol that allows the update tool on the host to pass the update image to the device.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the described <a class="reference internal" href="config_channel.html#nrf-desktop-config-channel"><span class="std std-ref">Configuration channel</span></a> options are used by the <a class="reference internal" href="../../../scripts/hid_configurator/README.html#nrf-desktop-config-channel-script"><span class="std std-ref">HID configurator for nRF Desktop</span></a> during the DFU.
You can trigger DFU using a single command in the CLI.</p>
</div>
<p>The following <a class="reference internal" href="config_channel.html#nrf-desktop-config-channel"><span class="std std-ref">Configuration channel</span></a> options are available to perform the firmware update:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#dfu-fwinfo"><span class="std std-ref">fwinfo</span></a> - Passes the information about the currently executed image from the device to the host.</p></li>
<li><p><a class="reference internal" href="#dfu-reboot"><span class="std std-ref">reboot</span></a> - Reboots the device.</p></li>
<li><p><a class="reference internal" href="#dfu-start"><span class="std std-ref">start</span></a> - Starts the new update image transmission.</p></li>
<li><p><a class="reference internal" href="#dfu-data"><span class="std std-ref">data</span></a> - Passes a chunk of the update image data from the host to the device.</p></li>
<li><p><a class="reference internal" href="#dfu-sync"><span class="std std-ref">sync</span></a> - Checks the progress of the update image transmission.</p></li>
<li><p><a class="reference internal" href="#dfu-bootloader-var"><span class="std std-ref">module_variant</span></a> - Provides the host with the information about the bootloader variant used on the device.</p></li>
</ul>
<dl class="simple" id="dfu-fwinfo">
<dt>fwinfo</dt><dd><p>Perform the fetch operation on this option to get the following information about the currently executed image:</p>
<ul class="simple">
<li><p>Version and length of the image.</p></li>
<li><p>Partition ID of the image, used to specify the image placement on the flash.</p></li>
</ul>
</dd>
</dl>
<dl class="simple" id="dfu-reboot">
<dt>reboot</dt><dd><p>Perform the fetch operation on this option to trigger an instant reboot of the device.</p>
</dd>
</dl>
<dl id="dfu-start">
<dt>start</dt><dd><p>Perform the set operation on this option to start the DFU.
The operation contains the following data:</p>
<ul class="simple">
<li><p>Size of the image being transmitted.</p></li>
<li><p>Checksum of the update image.</p></li>
<li><p>Offset at which the host tool is going to start the image update.
If the image transfer is performed for the first time, the offset must be set to zero.</p></li>
</ul>
<p>When the host tool performs the set operation, the checksum and the size are recorded and the update process is started.</p>
<p>If the transmission is interrupted, the current offset position is stored along with the image checksum and size until the device is rebooted.
The host tool can restart the update image transfer after the interruption, but the checksum, the requested offset, and the size of the image must match the information stored by the device.</p>
</dd>
</dl>
<dl id="dfu-data">
<dt>data</dt><dd><p>Perform the set operation on this option to pass the chunk of the update image that should be stored at the current offset.
The data is initially buffered in RAM, and then it is written to the flash partition after a fetch operation is performed on the <code class="docutils literal notranslate"><span class="pre">sync</span></code> option.</p>
<p>If the set operation on the <code class="docutils literal notranslate"><span class="pre">data</span></code> option is successful, the offset in buffer is increased.
If the operation fails to be completed, the update process is interrupted.</p>
<p>For performance reasons, the <a class="reference internal" href="config_channel.html#nrf-desktop-config-channel"><span class="std std-ref">Configuration channel</span></a> set operation does not return any information back to the host.
To check that the update process is correct, the host tool must perform fetch operation on the <code class="docutils literal notranslate"><span class="pre">sync</span></code> option at regular intervals.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The DFU module does not check if the update image contains any valid data.
It also does not check if it is correctly signed.
When the update image is received, the host tool requests a reboot.
Then, the bootloader will check the image for validity and ensure that the signature is correct.
If the verification of the new images is successful, the new version of the application will boot.</p>
</div>
</dd>
</dl>
<dl id="dfu-sync">
<dt>sync</dt><dd><p>Perform the fetch operation on this option to read the following data:</p>
<ul class="simple">
<li><p>Information regarding the status of the update process.
The module can report one of the following states:</p>
<ul>
<li><p><code class="xref c c-macro docutils literal notranslate"><span class="pre">DFU_STATE_CLEANING</span></code> - The module is erasing the secondary image flash area.</p></li>
<li><p><code class="xref c c-macro docutils literal notranslate"><span class="pre">DFU_STATE_STORING</span></code> - The module is writing data to the secondary image flash area.</p></li>
<li><p><code class="xref c c-macro docutils literal notranslate"><span class="pre">DFU_STATE_ACTIVE</span></code> - The DFU is ongoing and the module is receiving the new image from the host.</p></li>
<li><p><code class="xref c c-macro docutils literal notranslate"><span class="pre">DFU_STATE_INACTIVE</span></code> - The module is not performing any operation, and the DFU can be started.</p></li>
</ul>
</li>
<li><p>Size of the update image being transmitted.</p></li>
<li><p>Checksum of the update image.</p></li>
<li><p>Offset at which the update process currently is.</p></li>
<li><p>Size of the RAM buffer used to store the data.
The host must synchronize the firmware image transfer progress at least on every synchronization buffer byte count.</p></li>
</ul>
<p>The update tool can fetch the <code class="docutils literal notranslate"><span class="pre">sync</span></code> option before starting the update process to see at which offset the update is to be restarted.</p>
<p>Fetching the <code class="docutils literal notranslate"><span class="pre">sync</span></code> option also triggers moving the image data from the RAM buffer to flash.</p>
</dd>
</dl>
<dl class="simple" id="dfu-bootloader-var">
<dt>module_variant</dt><dd><p>Perform the fetch operation on this option to get the information about the bootloader variant that is being used on the device.</p>
</dd>
</dl>
</section>
<section id="writing-data-to-flash">
<h3><a class="toc-backref" href="#id10">Writing data to flash</a><a class="headerlink" href="#writing-data-to-flash" title="Permalink to this heading"></a></h3>
<p>The image data that is received from the host is initially buffered in the RAM.
Writing the data to flash is triggered when the host performs the fetch operation on the <code class="docutils literal notranslate"><span class="pre">sync</span></code> option.
At that point, the <a class="reference internal" href="../../../scripts/hid_configurator/README.html#nrf-desktop-config-channel-script"><span class="std std-ref">HID configurator for nRF Desktop</span></a> waits until the data is written to flash before providing more image data chunks.</p>
<p>The data is stored in a secondary image flash partition using a dedicated work (<code class="xref c c-struct docutils literal notranslate"><span class="pre">k_work_delayable</span></code>).
The work stores a single chunk of data and resubmits itself.</p>
<p>To ensure that the flash write will not interfere with the device usability, the stored data is split into small chunks and written only if there are no HID reports transmitted and the Bluetooth connection state does not change.</p>
</section>
<section id="partition-preparation">
<h3><a class="toc-backref" href="#id11">Partition preparation</a><a class="headerlink" href="#partition-preparation" title="Permalink to this heading"></a></h3>
<p>The DFU module must prepare the partition before the update image can be stored.
This operation is done in the background.</p>
<p>To ensure that the memory erase will not interfere with the device usability, the memory pages are erased only if there are no HID reports transmitted and the Bluetooth connection state does not change.
For example, the memory is not erased right after the Bluetooth connection is established.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The DFU process cannot be started before the entire partition used for storing the update image is erased.
If the DFU command is rejected, you must wait until the flash area used for the update image is erased.</p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="failsafe.html" class="btn btn-neutral float-right" title="Failsafe module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dev_descr.html" class="btn btn-neutral" title="Device description module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2019-2023, Nordic Semiconductor.
      Last updated on Mar 20, 2023.

    </p>
</td>
<td id="nordiclogo">
  <a href="https://www.nordicsemi.com/"><img src="../../../_static/images/nordic-logo.png" border="0"/></a>
</td>
</tr>
</table>
  </div> 


</footer>

<div id="scroll-container">
  <button type="button" id="scroll-btn" class="btn">
    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="#fff"/></svg>
  </button>
</div>

<script>
  const scrollBtn = document.querySelector("#scroll-btn");

  document.addEventListener("scroll", () => {
    if (window.scrollY > 400) {
          scrollBtn.style.visibility = "visible";
      } else {
          scrollBtn.style.visibility = "hidden";
      }
  });

  scrollBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
  });
</script>
        </div>
      </div>
    </section>
  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> nRF Connect SDK</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <div class="rst-other-version ncs">
        <a href="../../../../nrf/index.html">nRF Connect SDK</a>
      </div>
      
      <div class="rst-other-version nrfx">
        <a href="../../../../nrfx/index.html">nrfx</a>
      </div>
      
      <div class="rst-other-version nrfxlib">
        <a href="../../../../nrfxlib/README.html">nrfxlib</a>
      </div>
      
      <div class="rst-other-version zephyr">
        <a href="../../../../zephyr/index.html">Zephyr Project</a>
      </div>
      
      <div class="rst-other-version mcuboot">
        <a href="../../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      
      <div class="rst-other-version tfm">
        <a href="../../../../tfm/index.html">Trusted Firmware-M</a>
      </div>
      
      <div class="rst-other-version matter">
        <a href="../../../../matter/index.html">Matter</a>
      </div>
      
      <div class="rst-other-version kconfig">
        <a href="../../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>